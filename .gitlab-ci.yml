variables:
  PLATFORMS: "linux/arm64/v8,linux/amd64"
  COMPOSE_VERSION: "1.29.2"


build:
  image: docker:latest
  services:
    - docker:dind

  script:
    - docker login -u "${CI_REGISTRY_USER}" -p "${CI_JOB_TOKEN}" "${CI_REGISTRY}"
    # Install QEMU emulation support in the kernel
    # See: https://docs.docker.com/buildx/working-with-buildx/#build-multi-platform-images
    - docker run --privileged --rm tonistiigi/binfmt --install all
    # Build and push images
    - ./bin/build.sh

  parallel:
    matrix:
      - BASE_IMAGE: ubuntu
        UBUNTU_VERSION: "18.04"
        DOCKER_VERSION: "5:20.10.17~3-0~ubuntu-bionic"
        OUTPUT_TAG_NAME: "18.04"
        EXTRA_BUILD_ARGS: "--tag ${CI_REGISTRY_IMAGE}:bionic"

      - BASE_IMAGE: ubuntu
        UBUNTU_VERSION: "20.04"
        DOCKER_VERSION: "5:20.10.17~3-0~ubuntu-focal"
        OUTPUT_TAG_NAME: "20.04"
        EXTRA_BUILD_ARGS: >-
          --tag ${CI_REGISTRY_IMAGE}:focal
          --push

      - BASE_IMAGE: ubuntu
        UBUNTU_VERSION: "22.04"
        DOCKER_VERSION: "5:20.10.17~3-0~ubuntu-jammy"
        OUTPUT_TAG_NAME: "22.04"
        EXTRA_BUILD_ARGS: >-
          --tag ${CI_REGISTRY_IMAGE}:jammy
          --tag ${CI_REGISTRY_IMAGE}:latest
          --push
